# =====================================================================
# 🚀 DEPLOY WEB APPLICATION WORKFLOW
# =====================================================================
name: 🚀 Deploy Web Application

# ---------------------------------------------------------------------
# 📋 WORKFLOW TRIGGERS
# ---------------------------------------------------------------------
on:
  workflow_dispatch: # 👆 Allow manual triggering
  release:
    types: [published] # 📦 Run when a new release is published

# ---------------------------------------------------------------------
# 🔐 PERMISSIONS (required for GitHub Pages)
# ---------------------------------------------------------------------
permissions:
  contents: read
  pages: write
  id-token: write

# ---------------------------------------------------------------------
# 💼 JOBS
# ---------------------------------------------------------------------
jobs:
  deploy:
    name: 🔄 Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 15 # ⏱️ Set a timeout to prevent long-running jobs
    environment:
      name: github-pages
      url: ${{ steps.pages_deploy.outputs.page_url }}
    
    # -------------------------------------------------------------
    # 🌍 ENVIRONMENT VARIABLES (Frontend build-time)
    # -------------------------------------------------------------
    env:
      NODE_ENV: production
      # Chain selection (optional): set one of these
      VITE_CHAIN_ID: ${{ vars.VITE_CHAIN_ID }}
      VITE_CHAIN_NAME: ${{ vars.VITE_CHAIN_NAME }}
      # WalletConnect (usually secret)
      VITE_WC_PROJECT_ID: ${{ secrets.VITE_WC_PROJECT_ID }}
      # RPC URLs (keep secret if they embed keys)
      VITE_RPC_HTTP_URL_MAINNET: ${{ secrets.VITE_RPC_HTTP_URL_MAINNET }}
      VITE_RPC_HTTP_URL_SEPOLIA: ${{ secrets.VITE_RPC_HTTP_URL_SEPOLIA }}
      # Subgraph URLs (typically non-secret)
      VITE_SUBGRAPH_URL_MAINNET: ${{ vars.VITE_SUBGRAPH_URL_MAINNET }}
      VITE_SUBGRAPH_URL_SEPOLIA: ${{ vars.VITE_SUBGRAPH_URL_SEPOLIA }}

    steps:
      # 📥 CHECKOUT
      - name: 📥 Checkout repository code
        uses: actions/checkout@v5.0.0

      # 🛠️ SETUP ENVIRONMENT
      - name: 🔧 Install Foundry
        uses: foundry-rs/foundry-toolchain@v1.4.0
        with:
          version: nightly

      - name: 📦 Install pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          run_install: false

      - name: 🟢 Install Node.js
        uses: actions/setup-node@v4
        with:
          cache: "pnpm"
          node-version-file: "package.json"

      # 📚 DEPENDENCIES
      - name: 📚 Install dependencies
        run: pnpm install

      # 🏗️ BUILD
      - name: 🏗️ Build the apps and packages
        run: pnpm run build

      # 🧪 TEST
      - name: 🧪 Execute tests
        run: pnpm run test

      # 🚀 DEPLOY TO PINME
      - name: 🚀 Deploy to pinme
        run: cd ./apps/web/ && pnpm pinme upload dist

      # 🌐 GITHUB PAGES DEPLOYMENT
      - name: ⚙️ Configure GitHub Pages
        uses: actions/configure-pages@v5.0.0

      - name: 📦 Upload Pages artifact
        uses: actions/upload-pages-artifact@v3.0.0
        with:
          path: apps/web/dist

      - name: 🌐 Deploy to GitHub Pages
        id: pages_deploy
        uses: actions/deploy-pages@v4.0.0
