# =====================================================================
# ğŸš€ DEPLOY WEB APPLICATION WORKFLOW
# =====================================================================
name: ğŸš€ Deploy Web Application

# ---------------------------------------------------------------------
# ğŸ“‹ WORKFLOW TRIGGERS
# ---------------------------------------------------------------------
on:
  workflow_dispatch: # ğŸ‘† Allow manual triggering
  release:
    types: [published] # ğŸ“¦ Run when a new release is published

# ---------------------------------------------------------------------
# ğŸ” PERMISSIONS (required for GitHub Pages)
# ---------------------------------------------------------------------
permissions:
  contents: read
  pages: write
  id-token: write

# ---------------------------------------------------------------------
# ğŸ’¼ JOBS
# ---------------------------------------------------------------------
jobs:
  deploy:
    name: ğŸ”„ Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 15 # â±ï¸ Set a timeout to prevent long-running jobs
    environment:
      name: github-pages
      url: ${{ steps.pages_deploy.outputs.page_url }}
    
    # -------------------------------------------------------------
    # ğŸŒ ENVIRONMENT VARIABLES (Frontend build-time)
    # -------------------------------------------------------------
    env:
      NODE_ENV: production
      # Chain selection (optional): set one of these
      VITE_CHAIN_ID: ${{ vars.VITE_CHAIN_ID }}
      VITE_CHAIN_NAME: ${{ vars.VITE_CHAIN_NAME }}
      # WalletConnect (usually secret)
      VITE_WC_PROJECT_ID: ${{ secrets.VITE_WC_PROJECT_ID }}
      # Unified endpoints
      VITE_RPC_HTTP_URL: ${{ secrets.VITE_RPC_HTTP_URL }}
      VITE_SUBGRAPH_URL: ${{ vars.VITE_SUBGRAPH_URL }}

    steps:
      # ğŸ“¥ CHECKOUT
      - name: ğŸ“¥ Checkout repository code
        uses: actions/checkout@v5.0.0

      # ğŸ› ï¸ SETUP ENVIRONMENT
      - name: ğŸ”§ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1.4.0
        with:
          version: nightly

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          run_install: false

      - name: ğŸŸ¢ Install Node.js
        uses: actions/setup-node@v4
        with:
          cache: "pnpm"
          node-version-file: "package.json"

      # ğŸ“š DEPENDENCIES
      - name: ğŸ“š Install dependencies
        run: pnpm install

      # ğŸ—ï¸ BUILD
      - name: ğŸ—ï¸ Build the apps and packages
        run: pnpm run build

      # ğŸ§ª TEST
      - name: ğŸ§ª Execute tests
        run: pnpm run test

      # ğŸš€ DEPLOY TO PINME
      - name: ğŸš€ Deploy to pinme
        run: cd ./apps/web/ && pnpm pinme upload dist

      # ğŸŒ GITHUB PAGES DEPLOYMENT
      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v5.0.0

      - name: ğŸ“¦ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3.0.0
        with:
          path: apps/web/dist

      - name: ğŸŒ Deploy to GitHub Pages
        id: pages_deploy
        uses: actions/deploy-pages@v4.0.0
